import { useEffect, useState, createContext } from "react";
import "./App.css";
import InputField from "./inputField/InputField";
import Dashboard from "./dashboard/Dashboard";
import { getLocation } from "./inputField/Utils";
import { getCityName, getWeatherBasedOnCity, getIcon } from "./ApiCalls";

export const LocationContext = createContext(null);
export const WeatherContext = createContext(null);

function App() {
  const [cityName, setCityName] = useState("");
  const [coordinates, setCoordinates] = useState(null);
  const [weatherData, setWeatherData] = useState({});
  const [weatherIcon, setWeatherIcon] = useState(null);
  const [cityFromInputField, setCityFromInputField] = useState("");

  const success = (pos) => {
    const crd = pos.coords;
    setCoordinates(crd);
  };

  useEffect(() => {
    getLocation(success); // get co-ordinates
  }, []);

  useEffect(() => {
    if (coordinates) {
      getCityName(coordinates).then((data) => setCityName(data.locality));
    }
  }, [coordinates]);

  useEffect(() => {
    if (cityName) {
      getWeatherBasedOnCity(cityName).then((weather) => {
        setWeatherData(weather);
        weather?.weather?.[0]?.icon &&
          getIcon(weather?.weather?.[0]?.icon).then((response) =>
            response.blob().then((blobResponse) => {
              setWeatherIcon(URL.createObjectURL(blobResponse));
            })
          );
      });
    }

    if (cityFromInputField) {
      const timer = setTimeout(() => {
        getWeatherBasedOnCity(cityFromInputField).then((weather) => {
          setWeatherData(weather);
          console.log(weather);
          weather?.weather?.[0]?.icon &&
            getIcon(weather?.weather?.[0]?.icon).then((response) =>
              response.blob().then((blobResponse) => {
                setWeatherIcon(URL.createObjectURL(blobResponse));
              })
            );
        });
      }, 3000);
      return () => clearTimeout(timer);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [cityName, cityFromInputField]);

  return (
    <LocationContext.Provider value={cityName}>
      <WeatherContext.Provider value={weatherData}>
        <div className="App">
          {weatherData === null ? (
            <div class="fa-3x">
              <i class="fas fa-spinner fa-pulse" />
            </div>
          ) : null}
          <header className="App-header">
            <InputField setCityFromInputFields={setCityFromInputField} />
            <img
              src={`data:image/svg+xml,%3Csvg%20version%3D%221.0%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20%20width%3D%22300.000000pt%22%20height%3D%22300.000000pt%22%20viewBox%3D%220%200%20300.000000%20300.000000%22%20%20preserveAspectRatio%3D%22xMidYMid%20meet%22%3E%3Cg%20transform%3D%22translate(0.000000%2C300.000000)%20scale(0.100000%2C-0.100000)%22%20fill%3D%22rgb(0%2098%20255)%22%20stroke%3D%22none%22%3E%3Cpath%20d%3D%22M1315%202681%20c-48%20-22%20-79%20-54%20-100%20-104%20-8%20-20%20-15%20-39%20-15%20-42%201%20-51%20-3%20-61%20-42%20-97%20-79%20-73%20-93%20-114%20-62%20-177%2035%20-70%20-18%20-66%20854%20-69%20432%20-2%20800%200%20818%203%2032%206%2061%2037%2067%2072%204%2028%20-26%2071%20-59%2084%20-17%207%20-46%2030%20-64%2051%20-41%2047%20-87%2058%20-152%2035%20-116%20-40%20-144%20-31%20-155%2052%20-4%2027%20-15%2062%20-25%2079%20-23%2037%20-87%2072%20-133%2072%20-34%200%20-127%20-51%20-127%20-69%200%20-6%20-20%20-19%20-45%20-30%20-38%20-17%20-54%20-19%20-94%20-11%20-26%205%20-58%206%20-69%203%20-13%20-3%20-43%206%20-74%2021%20-56%2028%20-129%2034%20-172%2015%20-20%20-10%20-33%20-7%20-79%2015%20-30%2015%20-65%2039%20-78%2053%20-29%2031%20-95%2063%20-129%2062%20-14%200%20-43%20-9%20-65%20-18z%20m133%20-21%20c26%20-12%2050%20-33%2063%20-55%2015%20-24%2027%20-34%2037%20-30%2019%207%2062%20-21%2062%20-41%200%20-9%203%20-14%208%20-12%2091%2047%20166%2050%20224%207%2029%20-22%2038%20-24%2071%20-15%2031%208%2047%206%2086%20-11%20l48%20-20%209%2021%20c6%2014%2018%2021%2037%2021%2019%201%2032%208%2040%2024%2060%20119%20252%2070%20252%20-65%200%20-26%205%20-46%2013%20-49%206%20-2%2012%20-13%2012%20-24%200%20-22%2047%20-38%2063%20-22%206%206%2022%2011%2037%2011%2014%200%2034%207%2044%2015%2023%2018%2079%2020%20109%204%2028%20-15%2056%20-49%2057%20-70%200%20-12%207%20-15%2024%20-12%2017%204%2033%20-3%2050%20-20%2031%20-32%2032%20-46%205%20-81%20l-21%20-26%20-809%202%20-809%203%20-26%2026%20c-16%2016%20-28%2041%20-31%2067%20-5%2038%20-2%2044%2031%2076%2055%2050%2056%2052%2078%2076%2011%2013%2017%2028%2013%2040%20-10%2031%2013%2097%2046%20129%2050%2051%20110%2061%20177%2031z%22%2F%3E%3Cpath%20d%3D%22M650%202553%20c-8%20-3%20-26%20-17%20-40%20-30%20-45%20-44%20-78%20-55%20-132%20-48%20-61%209%20-98%20-5%20-155%20-57%20-24%20-21%20-48%20-38%20-55%20-38%20-7%200%20-32%20-19%20-55%20-42%20-53%20-52%20-58%20-94%20-17%20-127%2026%20-20%2038%20-21%20346%20-21%20l320%200%2029%2029%20c44%2044%2040%2090%20-10%20142%20-23%2025%20-42%2055%20-46%2076%20-10%2054%20-23%2076%20-60%20101%20-33%2021%20-90%2028%20-125%2015z%20m109%20-28%20c33%20-17%2065%20-77%2056%20-105%20-5%20-15%205%20-31%2039%20-63%2024%20-23%2045%20-49%2046%20-57%205%20-32%20-1%20-51%20-20%20-70%20-19%20-19%20-33%20-20%20-345%20-20%20l-325%200%20-15%2024%20c-19%2029%20-6%2071%2024%2081%2012%203%2021%2013%2021%2020%200%2018%2037%2038%2055%2031%208%20-3%2022%208%2033%2028%2034%2058%20116%2082%20176%2051%2035%20-19%2033%20-19%2039%206%205%2017%2011%2020%2031%2017%2017%20-4%2026%20-1%2026%207%200%207%2014%2025%2031%2039%2035%2030%2084%2034%20128%2011z%22%2F%3E%3Cpath%20d%3D%22M1068%202065%20c-126%20-46%20-187%20-179%20-142%20-311%2015%20-44%2015%20-47%20-5%20-68%20-30%20-32%20-27%20-79%205%20-105%2026%20-21%2036%20-21%20496%20-21%20515%200%20512%200%20543%2060%2027%2052%2016%2093%20-36%20138%20-16%2013%20-29%2031%20-29%2040%200%2025%20-48%2099%20-78%20121%20-16%2011%20-50%2025%20-75%2032%20-61%2015%20-127%20-2%20-177%20-46%20-34%20-30%20-38%20-31%20-107%20-27%20l-72%204%20-17%2044%20c-45%20118%20-187%20183%20-306%20139z%20m183%20-33%20c61%20-32%20107%20-95%20116%20-159%20l5%20-39%2039%2019%20c33%2016%2044%2017%2074%207%2019%20-6%2037%20-15%2040%20-20%203%20-5%2027%2013%2053%2040%2039%2040%2055%2049%2096%2055%2094%2014%20191%20-54%20203%20-144%204%20-26%2011%20-41%2020%20-41%208%200%2025%20-11%2038%20-25%2035%20-34%2033%20-78%20-4%20-116%20l-29%20-29%20-476%200%20c-463%200%20-477%201%20-496%2020%20-11%2011%20-20%2027%20-20%2035%200%2023%2040%2057%2060%2052%2016%20-4%2015%201%20-8%2035%20-32%2050%20-42%20145%20-20%20198%2053%20126%20189%20175%20309%20112z%22%2F%3E%3Cpath%20d%3D%22M465%201934%20c-45%20-23%20-65%20-45%20-89%20-94%20l-21%20-45%20-55%203%20c-48%203%20-59%200%20-88%20-25%20-25%20-21%20-35%20-39%20-39%20-70%20-8%20-58%2010%20-96%2057%20-122%2038%20-21%2049%20-22%20251%20-19%20l211%203%2024%2028%20c29%2034%2031%2076%204%20110%20-12%2015%20-20%2040%20-20%2065%200%20127%20-131%20220%20-235%20166z%20m152%20-32%20c45%20-32%2067%20-84%2059%20-143%20-5%20-40%20-4%20-49%208%20-49%2038%200%2048%20-78%2014%20-110%20-20%20-19%20-34%20-20%20-225%20-20%20-228%200%20-254%206%20-278%2063%20-28%2068%2020%20137%2095%20137%2021%200%2041%20-4%2044%20-9%204%20-5%2017%20-4%2031%202%2017%208%2025%2020%2025%2038%200%2031%2031%2074%2074%20101%2040%2024%20111%2020%20153%20-10z%22%2F%3E%3Cpath%20d%3D%22M2388%201900%20c-20%20-11%20-49%20-35%20-65%20-54%20-16%20-19%20-42%20-37%20-59%20-40%20-20%20-5%20-51%20-27%20-83%20-62%20-61%20-65%20-66%20-97%20-22%20-146%20l29%20-33%20282%20-2%20c234%20-2%20286%200%20310%2012%2036%2019%2050%2043%2050%2088%200%2028%20-10%2043%20-52%2086%20-29%2028%20-64%2054%20-78%2057%20-14%204%20-41%2023%20-60%2044%20-19%2020%20-49%2045%20-67%2054%20-44%2022%20-138%2020%20-185%20-4z%20m207%20-34%20c21%20-16%2043%20-42%2049%20-58%209%20-24%2015%20-28%2034%20-23%2026%206%2072%20-18%2072%20-38%200%20-6%2013%20-20%2030%20-29%2039%20-22%2049%20-62%2023%20-96%20l-20%20-27%20-299%20-3%20c-295%20-2%20-299%20-2%20-316%2019%20-22%2026%20-23%2074%20-2%2091%2017%2014%2032%2030%2065%2067%2016%2018%2028%2022%2050%2017%2016%20-3%2029%20-1%2029%203%200%2016%2052%2073%2085%2093%2048%2030%20150%2022%20200%20-16z%22%2F%3E%3Cpath%20d%3D%22M1444%201402%20c-49%20-20%20-84%20-47%20-108%20-84%20-24%20-36%20-34%20-35%20-87%207%20-72%2057%20-132%2058%20-194%204%20-26%20-23%20-37%20-43%20-45%20-84%20-9%20-41%20-20%20-62%20-51%20-92%20-46%20-45%20-58%20-87%20-35%20-132%2032%20-61%2028%20-60%20538%20-61%20454%200%20465%200%20491%2020%2014%2011%2029%2030%2032%2041%209%2028%20-30%2083%20-80%20110%20-22%2013%20-52%2035%20-66%2051%20-15%2015%20-47%2033%20-72%2039%20-40%2011%20-46%2017%20-57%2052%20-16%2056%20-85%20121%20-142%20135%20-60%2015%20-74%2015%20-124%20-6z%20m118%20-12%20c68%20-19%20138%20-101%20138%20-162%200%20-20%205%20-23%2041%20-24%2045%20-2%2088%20-28%20104%20-63%206%20-13%2016%20-20%2026%20-18%2021%206%2049%20-10%2049%20-27%200%20-8%209%20-16%2020%20-19%2010%20-3%2022%20-17%2026%20-33%206%20-22%202%20-31%20-16%20-46%20-21%20-17%20-51%20-18%20-490%20-18%20l-468%200%20-31%2026%20c-38%2031%20-42%2080%20-10%20110%2067%2063%2079%2079%2079%20112%200%20106%20125%20159%20202%2086%2015%20-15%2028%20-33%2028%20-40%200%20-7%208%20-10%2020%20-7%2011%203%2026%200%2033%20-6%2010%20-8%2017%20-2%2031%2029%2026%2059%2096%20106%20161%20109%2011%201%2037%20-4%2057%20-9z%22%2F%3E%3Cpath%20d%3D%22M358%201361%20c-51%20-17%20-98%20-85%20-98%20-144%200%20-14%20-17%20-40%20-45%20-67%20-57%20-56%20-62%20-101%20-16%20-152%20l29%20-33%20195%200%20c182%200%20197%201%20223%2021%2047%2035%2067%2070%2067%20116%200%2064%20-23%2099%20-100%20148%20-37%2024%20-86%2058%20-108%2076%20-44%2036%20-101%2049%20-147%2035z%20m110%20-31%20c18%20-11%2037%20-31%2043%20-44%208%20-16%2017%20-22%2030%20-19%2012%204%2028%20-4%2042%20-18%2013%20-13%2038%20-32%2056%20-41%2031%20-17%2061%20-68%2061%20-105%200%20-33%20-36%20-86%20-71%20-105%20-29%20-15%20-58%20-18%20-201%20-18%20-92%200%20-178%204%20-192%2010%20-15%205%20-33%2025%20-42%2043%20-14%2030%20-15%2038%20-3%2063%208%2016%2027%2035%2042%2042%2015%207%2027%2020%2027%2028%200%208%206%2017%2013%2020%208%203%2012%2016%209%2033%20-9%2060%2058%20131%20123%20131%2017%200%2045%20-9%2063%20-20z%22%2F%3E%3Cpath%20d%3D%22M2275%201291%20c-36%20-22%20-58%20-46%20-76%20-86%20-13%20-28%20-18%20-30%20-62%20-27%20-43%203%20-50%201%20-82%20-31%20-28%20-28%20-35%20-43%20-35%20-75%200%20-50%2041%20-97%2091%20-107%2019%20-3%20181%20-5%20361%20-3%20314%203%20328%204%20342%2023%2020%2026%2020%2058%201%2095%20-8%2016%20-15%2033%20-14%2037%205%2032%20-6%2060%20-35%2089%20-29%2029%20-41%2034%20-81%2034%20-32%200%20-57%20-7%20-76%20-21%20-44%20-31%20-110%20-20%20-144%2026%20-48%2062%20-131%2083%20-190%2046z%20m133%20-21%20c18%20-11%2040%20-35%2048%20-54%2015%20-31%2020%20-33%2053%20-29%2022%203%2043%20-1%2055%20-9%2016%20-13%2021%20-11%2046%2013%2036%2037%2069%2044%20114%2025%2041%20-17%2072%20-72%2060%20-108%20-4%20-13%202%20-28%2017%20-44%2019%20-20%2021%20-27%2011%20-49%20-6%20-13%20-22%20-27%20-34%20-30%20-13%20-3%20-173%20-5%20-356%20-3%20l-334%203%20-24%2028%20c-51%2060%20-15%20147%2060%20147%2019%200%2038%20-4%2041%20-10%2010%20-15%2044%2011%2050%2040%2019%2082%20120%20124%20193%2080z%22%2F%3E%3Cpath%20d%3D%22M709%20771%20c-48%20-30%20-79%20-84%20-79%20-139%200%20-15%20-10%20-39%20-23%20-54%20-22%20-28%20-22%20-28%20-72%20-14%20-28%207%20-61%2018%20-72%2025%20-55%2029%20-154%20-2%20-178%20-57%20-5%20-12%20-24%20-27%20-41%20-32%20-74%20-25%20-97%20-92%20-50%20-147%20l24%20-28%20594%20-3%20594%20-2%2023%2021%20c18%2017%2022%2028%2017%2052%20-3%2016%20-6%2054%20-6%2083%200%2047%20-4%2059%20-33%2090%20-27%2029%20-42%2037%20-82%2041%20-42%205%20-56%2012%20-90%2048%20-53%2057%20-104%2073%20-171%2053%20-55%20-16%20-106%20-6%20-128%2024%20-6%208%20-29%2027%20-50%2042%20-54%2037%20-117%2036%20-177%20-3z%20m168%20-12%20c18%20-11%2040%20-34%2048%20-50%2010%20-18%2020%20-26%2030%20-23%208%204%2025%200%2038%20-9%2020%20-13%2026%20-12%2057%204%2019%2011%2045%2019%2058%2019%2053%200%20122%20-48%20136%20-96%206%20-19%2012%20-20%2055%20-16%2040%203%2056%200%2080%20-17%2039%20-28%2057%20-80%2042%20-123%20-9%20-25%20-8%20-35%205%20-49%2012%20-14%2013%20-22%204%20-38%20-11%20-21%20-13%20-21%20-604%20-21%20-562%200%20-595%201%20-617%2018%20-50%2041%20-15%20122%2052%20122%2020%200%2029%205%2029%2016%200%209%2015%2031%2034%2050%2028%2028%2041%2034%2078%2034%2024%200%2053%20-7%2064%20-15%2010%20-8%2031%20-15%2045%20-15%2014%200%2034%20-6%2044%20-14%2022%20-16%2065%20-2%2065%2021%200%207%208%2018%2018%2024%2012%208%2016%2021%2014%2047%20-9%20113%20126%20192%20225%20131z%22%2F%3E%3Cpath%20d%3D%22M2475%20747%20c-67%20-26%20-111%20-80%20-121%20-148%20-4%20-24%20-18%20-63%20-32%20-87%20-47%20-82%20-10%20-177%2078%20-203%2021%20-7%2097%20-10%20185%20-7%20138%203%20153%205%20183%2026%2064%2046%2084%20134%2046%20200%20-10%2019%20-30%2055%20-44%2080%20-15%2028%20-38%2053%20-56%2063%20-18%208%20-46%2027%20-63%2042%20-52%2043%20-119%2056%20-176%2034z%20m121%20-26%20c22%20-10%2049%20-30%2060%20-43%2011%20-14%2025%20-23%2032%20-20%2023%207%2062%20-27%2062%20-54%200%20-15%2013%20-41%2030%20-60%2039%20-45%2047%20-93%2024%20-140%20-36%20-71%20-56%20-79%20-229%20-82%20-125%20-3%20-160%200%20-187%2012%20-40%2019%20-68%2062%20-68%20106%200%2034%2025%2090%2040%2090%206%200%2010%2019%2010%2043%200%2059%2035%20115%2089%20144%2053%2028%2083%2029%20137%204z%22%2F%3E%3Cpath%20d%3D%22M1969%20718%20c-13%20-5%20-38%20-20%20-55%20-33%20-42%20-32%20-120%20-58%20-154%20-51%20-40%208%20-96%20-11%20-135%20-45%20-78%20-69%20-56%20-208%2039%20-253%2032%20-15%2067%20-17%20287%20-14%20l251%203%2024%2028%20c40%2047%2033%2096%20-21%20157%20-29%2033%20-45%2060%20-45%2077%200%2032%20-43%20108%20-67%20118%20-34%2015%20-101%2021%20-124%2013z%20m96%20-22%20c42%20-18%2068%20-57%2071%20-108%201%20-22%207%20-45%2013%20-51%206%20-6%2011%20-16%2011%20-23%200%20-6%2011%20-15%2025%20-18%2030%20-8%2059%20-59%2049%20-89%20-3%20-12%20-16%20-32%20-27%20-44%20-20%20-23%20-24%20-23%20-264%20-23%20-264%200%20-280%203%20-322%2056%20-33%2042%20-36%2086%20-11%20139%2032%2066%20102%2097%20164%2071%2030%20-12%2035%20-12%2040%200%207%2019%2047%2034%2066%2024%2010%20-6%2020%201%2032%2021%2018%2030%2067%2058%20101%2059%2010%200%2033%20-6%2052%20-14z%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E`}
              alt="cloud"
            />
          </header>
          <br></br>
          <section className="App-body">
            {weatherData?.weather?.[0]?.icon && (
              <img src={weatherIcon} className="App-logo" alt="logo" />
            )}
            <Dashboard cityFromInputFields={cityFromInputField} />
          </section>
        </div>
      </WeatherContext.Provider>
    </LocationContext.Provider>
  );
}

export default App;
